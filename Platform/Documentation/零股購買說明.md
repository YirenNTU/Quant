# 📊 零股購買功能說明

## 🎯 功能概述

資產配置器 (`Allocator`) 現在支援零股購買功能，允許購買不足一張（1000股）的股票，讓資金配置更加靈活和精確。

---

## ✨ 新增功能

### 參數說明

在 `get_allocation()` 函數中新增了 `allow_fractional` 參數：

```python
allocation = get_allocation(
    strategy=strategy,
    capital=1_000_000,
    max_positions=10,
    min_weight=0.01,          # 降低最小權重
    allow_fractional=True,     # 🆕 允許零股購買
)
```

### 參數詳解

| 參數 | 類型 | 預設值 | 說明 |
|------|------|--------|------|
| `allow_fractional` | `bool` | `False` | 是否允許零股交易<br>- `True`: 允許購買零股（如 500 股 = 0.5 張）<br>- `False`: 只買整張（1000 股的倍數） |

---

## 📋 使用範例

### 範例 1: 啟用零股購買

```python
from Platform import get_allocation

allocation = get_allocation(
    strategy=MyStrategy(),
    capital=1_000_000,
    max_positions=10,
    min_weight=0.01,          # 降低最小權重，讓更多股票符合條件
    allow_fractional=True,     # 啟用零股購買
)

print(allocation)
```

**輸出範例**:
```
================================================================================
📊 資產配置建議: 我的策略
================================================================================

📅 日期: 2026-02-08
💰 可用資金: $1,000,000
📈 持倉數量: 10 檔

┌────────┬────────────┬──────────┬────────────┬────────────┬──────────┐
│股票    │公司名稱    │權重(%)   │股價        │金額        │張數      │
├────────┼────────────┼──────────┼────────────┼────────────┼──────────┤
│2330    │台積電      │    10.0  │     580,000│    580,000│     1.00│
│2317    │鴻海        │     8.5  │     105,000│     85,000│     0.81│  ← 零股
│2454    │聯發科      │     7.2  │     920,000│     72,000│     0.08│  ← 零股
...
```

### 範例 2: 比較零股與整張的差異

```python
# 不使用零股（預設）
allocation_no_fractional = get_allocation(
    strategy=MyStrategy(),
    capital=1_000_000,
    max_positions=10,
    allow_fractional=False,  # 預設值
)

# 使用零股
allocation_with_fractional = get_allocation(
    strategy=MyStrategy(),
    capital=1_000_000,
    max_positions=10,
    allow_fractional=True,
)

print(f"不使用零股: {allocation_no_fractional.summary['n_positions']} 檔")
print(f"使用零股: {allocation_with_fractional.summary['n_positions']} 檔")
print(f"資金利用率: {allocation_with_fractional.summary['allocation_pct']*100:.1f}%")
```

---

## 🔍 功能特點

### 1. 精確資金配置

**不使用零股**:
- 資金可能無法完全利用
- 某些股票因為不足一張而被跳過
- 可能只推薦 1-2 檔股票

**使用零股**:
- ✅ 資金利用率更高
- ✅ 可以購買更多檔股票
- ✅ 權重分配更精確

### 2. 計算邏輯

當 `allow_fractional=True` 時：

```python
# 直接計算股數，不取整到整張
shares = target_amount / price

# 如果權重夠高但股數太少，至少買 1 股
if shares < 1 and weight >= min_weight:
    shares = 1

# 換算成張數（可能是小數）
lots = shares / lot_size  # 例如: 500 股 = 0.5 張
```

### 3. 顯示格式

- **整張**: 顯示整數（如 `1`, `2`）
- **零股**: 顯示小數（如 `0.50`, `0.81`）

---

## ⚠️ 注意事項

### 1. 台股零股交易

- 台股零股交易時間：**13:40-14:30**
- 流動性較低，可能無法立即成交
- 部分券商可能不支援零股交易
- 建議確認你的券商是否支援零股交易

### 2. 回測相容性

回測引擎 (`Backtester`) 也有 `allow_fractional` 參數：

```python
from Platform import Backtester

result = Backtester.run(
    strategy=MyStrategy(),
    allow_fractional=True,  # 回測時也使用零股
)
```

### 3. 最小權重建議

使用零股時，建議降低 `min_weight`：

```python
allocation = get_allocation(
    strategy=strategy,
    min_weight=0.01,  # 從 0.03 降低到 0.01
    allow_fractional=True,
)
```

---

## 📊 實際應用場景

### 場景 1: 資金較小

```python
# 資金只有 10 萬元，想買多檔股票
allocation = get_allocation(
    strategy=MyStrategy(),
    capital=100_000,          # 10 萬元
    max_positions=10,
    min_weight=0.01,
    allow_fractional=True,    # 必須使用零股才能買多檔
)
```

### 場景 2: 高價股配置

```python
# 台積電股價高，想分散配置
allocation = get_allocation(
    strategy=MyStrategy(),
    capital=1_000_000,
    max_positions=10,
    allow_fractional=True,    # 可以買 0.5 張台積電
)
```

### 場景 3: 精確權重分配

```python
# 需要精確的權重分配（如 7.5%, 8.3%）
allocation = get_allocation(
    strategy=MyStrategy(),
    capital=1_000_000,
    min_weight=0.01,
    allow_fractional=True,    # 可以精確配置到小數點
)
```

---

## 🔧 疑難排解

### Q: 為什麼還是只推薦一檔股票？

**A**: 檢查以下幾點：

1. **策略分數問題**: 確認策略的 `compute()` 方法返回多檔股票的有效分數
2. **篩選條件**: 檢查 `filter_universe()` 是否過度篩選
3. **最小權重**: 降低 `min_weight` 參數
4. **資金不足**: 增加 `capital` 或啟用零股

```python
# 調試代碼
allocation = get_allocation(
    strategy=strategy,
    capital=1_000_000,
    max_positions=10,
    min_weight=0.01,          # 降低最小權重
    allow_fractional=True,     # 啟用零股
)

print(f"推薦股票數: {allocation.summary['n_positions']}")
if allocation.summary['n_positions'] == 1:
    print("⚠️ 只推薦一檔，檢查策略分數和篩選條件")
```

### Q: 零股顯示的張數是正確的嗎？

**A**: 是的，`lots` 欄位會顯示小數（如 `0.5` 表示 500 股），`shares` 欄位會顯示實際股數。

### Q: 回測時也要用零股嗎？

**A**: 建議回測和實際配置使用相同的設定：

```python
# 回測
result = Backtester.run(
    strategy=strategy,
    allow_fractional=True,
)

# 配置
allocation = get_allocation(
    strategy=strategy,
    allow_fractional=True,
)
```

---

## 📝 更新日誌

### v1.1 (2026-02-08)
- ✅ 新增 `allow_fractional` 參數支援零股購買
- ✅ 更新顯示格式支援小數張數
- ✅ 改善資金利用率

---

**最後更新**: 2026-02-08
