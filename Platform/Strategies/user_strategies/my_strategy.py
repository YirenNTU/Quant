#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
================================================================================
ğŸ“Š ç­–ç•¥ç¯„æœ¬ - Strategy Template
================================================================================

é€™æ˜¯ä¸€å€‹é€šç”¨çš„ç­–ç•¥ç¯„æœ¬ï¼Œä½ å¯ä»¥è¤‡è£½é€™å€‹æª”æ¡ˆä¸¦ä¿®æ”¹ compute() æ–¹æ³•ä¾†å»ºç«‹è‡ªå·±çš„ç­–ç•¥ã€‚

ä½¿ç”¨æ–¹å¼:
1. è¤‡è£½é€™å€‹æª”æ¡ˆä¸¦é‡æ–°å‘½åï¼Œä¾‹å¦‚: my_strategy.py
2. ä¿®æ”¹ name, description, params
3. åœ¨ compute() ä¸­å¯¦ä½œä½ çš„ç­–ç•¥é‚è¼¯
4. åŸ·è¡Œ: python my_strategy.py

================================================================================
"""

import sys
from pathlib import Path

# è¨­å®šè·¯å¾‘ (ç¢ºä¿å¯ä»¥ import Platform)
PROJECT_ROOT = Path(__file__).parent.parent.parent.parent
sys.path.insert(0, str(PROJECT_ROOT))

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# åŒ¯å…¥å¿…è¦æ¨¡çµ„
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

from Platform.Strategies import Strategy
from Platform.Factors import *

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ä½ çš„ç­–ç•¥
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

class MyStrategy(Strategy):
    """
    ç­–ç•¥æè¿°
    
    åœ¨é€™è£¡èªªæ˜ä½ çš„ç­–ç•¥é‚è¼¯...
    """
    
    # =========================================================================
    # åŸºæœ¬è³‡è¨Š (è«‹ä¿®æ”¹)
    # =========================================================================
    
    name = "æˆ‘çš„ç­–ç•¥"                    # ç­–ç•¥åç¨±
    description = "é€™æ˜¯æˆ‘çš„ç­–ç•¥èªªæ˜"      # ç­–ç•¥æè¿°
    version = "1.0"                      # ç‰ˆæœ¬
    author = "ä½ çš„åå­—"                  # ä½œè€…
    
    # =========================================================================
    # ç­–ç•¥åƒæ•¸ (å¯åœ¨é€™è£¡èª¿æ•´)
    # =========================================================================
    
    params = {
            "value_weight": 0.4,       # åƒ¹å€¼æ¬Šé‡
            "growth_weight": 0.4,      # è½‰æŠ˜æ¬Šé‡
            "chip_weight": 0.2,        # ç±Œç¢¼æ¬Šé‡
            "ma_filter": 60,           # è¶¨å‹¢éæ¿¾
        }
    
    # =========================================================================
    # æ ¸å¿ƒæ–¹æ³•: compute() - è¨ˆç®—å› å­åˆ†æ•¸ (å¿…é ˆå¯¦ä½œ)
    # =========================================================================
    
    def compute(self, db):
        """
        è¨ˆç®—å› å­åˆ†æ•¸
        
        Args:
            db: FieldDB è³‡æ–™åº«å¯¦ä¾‹ï¼Œç”¨æ–¼å–å¾—è³‡æ–™
        
        Returns:
            pd.DataFrame: å› å­åˆ†æ•¸ (rows=æ—¥æœŸ, cols=è‚¡ç¥¨)
                          åˆ†æ•¸è¶Šé«˜ä»£è¡¨è¶Šçœ‹å¥½é€™æª”è‚¡ç¥¨
        
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        å¯ç”¨è³‡æ–™ (ç”¨ db.get('æ¬„ä½åç¨±') å–å¾—)
        ğŸ“Œ æ‰€æœ‰è³‡æ–™éƒ½æœƒè‡ªå‹•å°é½Šåˆ°æ—¥å ±æ—¥æœŸï¼Œå¯ç›´æ¥é‹ç®—ï¼
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        ã€PRICE åƒ¹æ ¼é¡ã€‘21 å€‹æ¬„ä½ï¼Œå®Œæ•´åº¦ 99%+
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        close, open, high, low        æ”¶é–‹é«˜ä½åƒ¹
        volume, amount, trades        æˆäº¤é‡(è‚¡)ã€æˆäº¤é‡‘é¡ã€æˆäº¤ç­†æ•¸
        turnover                      é€±è½‰ç‡%
        mktcap, shares                å¸‚å€¼ã€æµé€šè‚¡æ•¸
        pe, pb, psr                   æœ¬ç›Šæ¯”ã€æ·¨å€¼æ¯”ã€ç‡Ÿæ”¶æ¯”
        pe_tej, pb_tej                PE/PB (TEJç‰ˆæœ¬)
        div_yield, cdiv_yield         æ®–åˆ©ç‡%ã€ç¾é‡‘æ®–åˆ©ç‡%
        daily_return, amplitude       æ—¥å ±é…¬ç‡%ã€æŒ¯å¹…%
        avgprc, adjfac                å‡åƒ¹ã€é‚„åŸå› å­
        
        ã€FINANCIALS è²¡å ±é¡ã€‘9 å€‹æ¬„ä½ï¼Œå®Œæ•´åº¦ 80%+ (å­£å ±é »ç‡)
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        revenue                       ç‡Ÿæ¥­æ”¶å…¥
        gross_profit                  æ¯›åˆ©
        net_income                    ç¨…å¾Œæ·¨åˆ©
        tej_gpm, tej_opm              æ¯›åˆ©ç‡%ã€ç‡Ÿç›Šç‡%
        inventory_turnover            å­˜è²¨é€±è½‰ç‡
        inventory_days                å­˜è²¨å¤©æ•¸
        dso                           æ‡‰æ”¶å¸³æ¬¾å¤©æ•¸
        days_payable                  æ‡‰ä»˜å¸³æ¬¾å¤©æ•¸
        
        ã€BALANCE_SHEET è³‡ç”¢è² å‚µé¡ã€‘5 å€‹æ¬„ä½ï¼Œå®Œæ•´åº¦ 80%+ (å­£å ±é »ç‡)
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        total_assets                  è³‡ç”¢ç¸½é¡
        total_debt                    è² å‚µç¸½é¡
        total_liabilities             ç¸½è² å‚µ
        current_assets                æµå‹•è³‡ç”¢
        accounts_receivable           æ‡‰æ”¶å¸³æ¬¾
        
        ã€CASHFLOW ç¾é‡‘æµé¡ã€‘1 å€‹æ¬„ä½ï¼Œå®Œæ•´åº¦ 94% (å­£å ±é »ç‡)
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        ocf                           ç‡Ÿæ¥­ç¾é‡‘æµ
        
        ã€CHIP ç±Œç¢¼é¡ã€‘9 å€‹æ¬„ä½ï¼Œå®Œæ•´åº¦ 100% (æ—¥é »)
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        qfii_net, fund_net            å¤–è³‡/æŠ•ä¿¡è²·è³£è¶…(å¼µ)
        dealer_net                    ä¸‰å¤§æ³•äººåˆè¨ˆ(å¼µ)
        qfii_pct, fund_pct            å¤–è³‡/æŠ•ä¿¡æŒè‚¡%
        dealer_pct                    è‡ªç‡Ÿå•†æŒè‚¡%
        margin_long, margin_short     èè³‡/èåˆ¸é¤˜é¡(å¼µ)
        short_ratio                   åˆ¸è³‡æ¯”%
        
        ã€CHIP_EXTENDED ç±Œç¢¼æ“´å……é¡ã€‘8 å€‹æ¬„ä½ï¼Œå®Œæ•´åº¦ 100% (æ—¥é »)
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        qfii_buy, qfii_sell           å¤–è³‡è²·é€²/è³£å‡ºé‡(å¼µ)
        fund_buy, fund_sell           æŠ•ä¿¡è²·é€²/è³£å‡ºé‡(å¼µ)
        margin_maintenance            èè³‡ç¶­æŒç‡%
        short_maintenance              èåˆ¸ç¶­æŒç‡%
        total_maintenance              æ•´æˆ¶ç¶­æŒç‡%
        stock_lending                 å€Ÿåˆ¸é¤˜é¡(å¼µ)
        
        ã€MONTHLY_SALES æœˆç‡Ÿæ”¶é¡ã€‘7 å€‹æ¬„ä½ï¼Œå®Œæ•´åº¦ 94% (æœˆé »)
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        monthly_rev                   ç•¶æœˆç‡Ÿæ”¶(åƒå…ƒ)
        monthly_rev_alt               æœˆç‡Ÿæ”¶(åƒå…ƒ)
        monthly_rev_yoy               æœˆç‡Ÿæ”¶YoY%
        monthly_rev_mom               æœˆç‡Ÿæ”¶MoM%
        ytd_rev                       ç´¯è¨ˆç‡Ÿæ”¶(åƒå…ƒ)
        ytd_rev_yoy                   ç´¯è¨ˆç‡Ÿæ”¶YoY%
        ytd_rev_yoy_pct               ç´¯è¨ˆç‡Ÿæ”¶MoM%
        
        ã€DIVIDEND è‚¡åˆ©é¡ã€‘18 å€‹æ¬„ä½ï¼Œå®Œæ•´åº¦ 98% (äº‹ä»¶é »ç‡)
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        cash_div, stock_div           ç¾é‡‘è‚¡åˆ©ã€è‚¡ç¥¨è‚¡åˆ©
        ern_div, cpl_div              ç›ˆé¤˜é…è‚¡ã€å…¬ç©é…è‚¡
        div_type                      é…æ¯é¡å‹
        div_beg_date, div_end_date    é…æ¯æœŸé–“èµ·/è¿„æ—¥
        div_year                      ç›ˆé¤˜åˆ†æ´¾å¹´åº¦
        div_payment_times             è‚¡åˆ©æ”¯ä»˜æ¬¡æ•¸
        div_payout_ratio              è‚¡åˆ©æ”¯ä»˜ç‡%
        ex_div_date, ex_right_date    é™¤æ¯æ—¥ã€é™¤æ¬Šæ—¥
        pay_date, stock_div_date      ç¾é‡‘/è‚¡ç¥¨è‚¡åˆ©ç™¼æ”¾æ—¥
        short_cover_date              é™¤æ¬Šæ¯æœ€å¾Œå›è£œæ—¥
        board_date                    è‘£äº‹æœƒæ—¥æœŸ
        shareholder_meeting_date      è‚¡æ±æœƒæ—¥æœŸ
        div_currency                  ç™¼æ”¾å¹£åˆ¥
        
        ã€CAPITAL è³‡æœ¬é¡ã€‘8 å€‹æ¬„ä½ï¼Œå®Œæ•´åº¦ 67% (äº‹ä»¶é »ç‡)
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        capital_amt                   è‚¡æœ¬(åƒå…ƒ)
        shares_outstanding             æµé€šè‚¡æ•¸(åƒè‚¡)
        cash_increase                 ç¾é‡‘å¢è³‡
        earning_increase               ç›ˆé¤˜è½‰å¢è³‡
        capital_reserve                è³‡æœ¬å…¬ç©
        employee_bonus                å“¡å·¥ç´…åˆ©
        capital_decrease               æ¸›è³‡
        capital_change_date            è³‡æœ¬è®Šæ›´æ—¥æœŸ
        
        ã€SELF_ANNOUNCED è‡ªçµè²¡å ±é¡ã€‘18 å€‹æ¬„ä½ï¼Œå®Œæ•´åº¦ 99% (å­£å ±é »ç‡)
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        sa_revenue                    è‡ªçµç‡Ÿæ”¶
        sa_gross_profit               è‡ªçµç‡Ÿæ¥­æ¯›åˆ©
        sa_opi                        è‡ªçµç‡Ÿæ¥­åˆ©ç›Š
        sa_pretax                     è‡ªçµç¨…å‰æ·¨åˆ©
        sa_net_income                 è‡ªçµç¨…å¾Œæ·¨åˆ©(åˆä½µç¸½æç›Š)
        sa_net_income_parent          è‡ªçµç¨…å¾Œæ·¨åˆ©(æ¯å…¬å¸)
        sa_eps                        è‡ªçµEPS
        sa_eps_pretax                 è‡ªçµæ¯è‚¡ç¨…å‰æ·¨åˆ©
        sa_eps_net                    è‡ªçµæ¯è‚¡ç¨…å¾Œæ·¨åˆ©
        sa_gpm                        è‡ªçµæ¯›åˆ©ç‡%
        sa_opm                        è‡ªçµç‡Ÿç›Šç‡%
        sa_pretax_npm                 è‡ªçµç¨…å‰æ·¨åˆ©ç‡%
        sa_npm                        è‡ªçµç¨…å¾Œæ·¨åˆ©ç‡%
        sa_rev_yoy                    è‡ªçµç‡Ÿæ”¶æˆé•·ç‡%
        sa_gm_yoy                     è‡ªçµç‡Ÿæ¥­æ¯›åˆ©æˆé•·ç‡%
        sa_opi_yoy                    è‡ªçµç‡Ÿæ¥­åˆ©ç›Šæˆé•·ç‡%
        sa_pretax_yoy                 è‡ªçµç¨…å‰æ·¨åˆ©æˆé•·ç‡%
        sa_ni_yoy                     è‡ªçµç¨…å¾Œæ·¨åˆ©æˆé•·ç‡%
        
        ã€SHAREHOLDING é›†ä¿åº«å­˜é¡ã€‘22 å€‹æ¬„ä½ï¼Œå®Œæ•´åº¦ 100% (æ—¥é »)
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        fc_shares                     é›†ä¿åº«å­˜è‚¡æ•¸(åƒè‚¡)
        pledged_shares                è¨­è³ªè‚¡æ•¸(åƒè‚¡)
        shrm_u400, shrs_u400, shrp_u400  æœªæ»¿400å¼µ: äººæ•¸/å¼µæ•¸/å æ¯”
        shrm_o400, shrs_o400, shrp_o400  è¶…é400å¼µ: äººæ•¸/å¼µæ•¸/å æ¯”
        shrm_4_6, shrs_4_6, shrp_4_6     400-600å¼µ: äººæ•¸/å¼µæ•¸/å æ¯”
        shrm_6_8, shrs_6_8, shrp_6_8     600-800å¼µ: äººæ•¸/å¼µæ•¸/å æ¯”
        shrm_8_10, shrs_8_10, shrp_8_10  800-1000å¼µ: äººæ•¸/å¼µæ•¸/å æ¯”
        shrm_o1000, shrs_o1000, shrp_o1000 è¶…é1000å¼µ: äººæ•¸/å¼µæ•¸/å æ¯”
        
        âš ï¸ TEJ åˆå…¥æ±Ÿæ¹–ç‰ˆç„¡è³‡æ–™ (è«‹å‹¿ä½¿ç”¨):
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        capex, icf, fcf               è³‡æœ¬æ”¯å‡ºã€æŠ•è³‡/ç±Œè³‡ç¾é‡‘æµ
        cash, inventory               ç¾é‡‘ã€å­˜è²¨
        
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        å¯ç”¨é‹ç®—å·¥å…·
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        ã€æ™‚åºé‹ç®— (Time-Series Operators)ã€‘
        ts_delay(data, periods)       N æœŸå‰çš„å€¼
        ts_delta(data, periods)       èˆ‡ N æœŸå‰çš„å·®å€¼
        ts_pct_change(data, periods)  N æœŸå ±é…¬ç‡
        ts_mean(data, window)         N æ—¥ç§»å‹•å¹³å‡
        ts_sum(data, window)          N æ—¥åŠ ç¸½
        ts_std(data, window)          N æ—¥æ¨™æº–å·®
        ts_max(data, window)          N æ—¥æœ€é«˜
        ts_min(data, window)          N æ—¥æœ€ä½
        ts_rank(data, window)        æ™‚åºæ’å (0~1)
        ts_zscore(data, window)      æ™‚åº Z-Score
        ts_corr(x, y, window)         æ»¾å‹•ç›¸é—œä¿‚æ•¸
        ts_cov(x, y, window)          æ»¾å‹•å…±è®Šç•°æ•¸
        ts_skew(data, window)         æ»¾å‹•åæ…‹
        ts_kurt(data, window)         æ»¾å‹•å³°æ…‹
        ts_argmax(data, window)       æœ€å¤§å€¼å¹¾æœŸå‰
        ts_argmin(data, window)       æœ€å°å€¼å¹¾æœŸå‰
        
        ã€æˆªé¢é‹ç®— (Cross-Section Operators)ã€‘
        rank(data, group=None)        æˆªé¢æ’å (0~1)ï¼Œå¯é¸åˆ†çµ„(ç”¢æ¥­å…§æ’å)
        zscore(data, group=None)      æˆªé¢ Z-Scoreï¼Œå¯é¸åˆ†çµ„(ç”¢æ¥­ä¸­æ€§åŒ–)
        demean(data)                  å»å‡å€¼
        neutralize(data, factor)      å°å› å­ä¸­æ€§åŒ–
        winsorize(data, lo, hi)       ç¸®å°¾è™•ç† (é è¨­ 0.01, 0.99)
        
        ã€è¡°æ¸›é‹ç®— (Decay Operators)ã€‘
        decay_linear(data, window)    ç·šæ€§è¡°æ¸›åŠ æ¬Š
        decay_exp(data, window)      æŒ‡æ•¸è¡°æ¸› (EMA)
        decay_power(data, window, p) å†ªæ¬¡è¡°æ¸›åŠ æ¬Š
        
        ã€é‚è¼¯é‹ç®— (Logical Operators)ã€‘
        if_else(cond, if_t, if_f)     æ¢ä»¶åˆ¤æ–·
        sign(data)                    ç¬¦è™Ÿå‡½æ•¸ (-1/0/1)
        abs_val(data)                 çµ•å°å€¼
        log(data)                      è‡ªç„¶å°æ•¸
        power(data, exp)               å†ªæ¬¡é‹ç®—
        
        ã€åŸºç¤é‹ç®— (Basic Operators)ã€‘
        add(a, b), subtract(a, b)    åŠ æ¸›é‹ç®—
        multiply(a, b), divide(a, b) ä¹˜é™¤é‹ç®—
        safe_divide(a, b, fill=0)     å®‰å…¨é™¤æ³•(é¿å…é™¤é›¶)
        
        ã€çµ„åˆå› å­ (Composite Factors)ã€‘
        momentum(data, periods)       å‹•é‡å› å­
        volatility(data, window)      æ³¢å‹•ç‡
        rsi(data, window=14)          RSI æŒ‡æ¨™ (0~100)
        bollinger_position(data, w, s) å¸ƒæ—é€šé“ä½ç½®
        macd(data, fast, slow, sig)   MACD æŒ‡æ¨™ (è¿”å› tuple)
        
        ã€ç”¢æ¥­åˆ†é¡å·¥å…· (Sector Tools)ã€‘
        load_sector(ref_df, field)    è¼‰å…¥ç”¢æ¥­è³‡æ–™
                                      field='sector' æˆ– 'industry'
                                      ç¯„ä¾‹: industry = load_sector(close, 'industry')
                                      æ­é… rank/zscore ä½¿ç”¨: rank(pe, industry)
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        """
        
        # =====================================================================
        # åœ¨é€™è£¡å¯¦ä½œä½ çš„ç­–ç•¥é‚è¼¯
        # =====================================================================
        
        # =========================
        # 1) å–è³‡æ–™ï¼ˆå…¨éƒ¨éƒ½æ˜¯ DB ç¢ºå®šå­˜åœ¨çš„æ¬„ä½ï¼‰
        # =========================
        close    = db.get("close")
        high     = db.get("high")
        volume   = db.get("volume")
        turnover = db.get("turnover")

        monthly_rev_yoy = db.get("monthly_rev_yoy")
        monthly_rev_mom = db.get("monthly_rev_mom")

        tej_opm  = db.get("tej_opm")
        tej_gpm  = db.get("tej_gpm")

        sa_ni_yoy  = db.get("sa_ni_yoy")      # âœ… æœ‰é€™å€‹æ¬„ä½ï¼ˆè‡ªçµç¨…å¾Œæ·¨åˆ© YoYï¼‰
        sa_opi_yoy = db.get("sa_opi_yoy")     # âœ… æœ‰ï¼ˆè‡ªçµç‡Ÿæ¥­åˆ©ç›Š YoYï¼‰â€” å¯ç”¨ä¾†åŠ å¼·ã€Œçˆ†ç™¼ã€

        qfii_net = db.get("qfii_net")
        fund_net = db.get("fund_net")
        qfii_pct = db.get("qfii_pct")
        fund_pct = db.get("fund_pct")

        industry = load_sector(close, "industry")

        # =========================
        # 2) è¶¨å‹¢æ¿¾ç¶²ï¼ˆå¤šé ­åšå¼·è€…ï¼‰
        # =========================
        ma20 = ts_mean(close, 20)
        ma60 = ts_mean(close, 60)
        trend_ok = (close > ma60) & (ma20 > ma60)

        # =========================
        # 3) Momentum + Breakoutï¼ˆæŠ“ä¸»å‡æ®µï¼‰
        # =========================
        mom20 = ts_pct_change(close, 20)
        mom60 = ts_pct_change(close, 60)
        mom_score = 0.55 * rank(mom20, industry) + 0.45 * rank(mom60, industry)

        hh120 = ts_max(high, 120)
        breakout_pos = safe_divide(close, hh120, fill=0)   # è¶Šæ¥è¿‘1è¶Šåƒçªç ´æ®µ
        breakout_score = rank(winsorize(breakout_pos, 0.01, 0.99), industry)

        # =========================
        # 4) é‡èƒ½ç¢ºèª
        # =========================
        vol20 = ts_mean(volume, 20)
        vol_surge = safe_divide(volume, vol20, fill=0)
        vol_score = rank(winsorize(ts_mean(vol_surge, 5), 0.01, 0.99), industry)

        turnover_score = rank(winsorize(ts_mean(turnover, 10), 0.01, 0.99), industry)

        # =========================
        # 5) åŸºæœ¬é¢åŠ é€Ÿï¼ˆçˆ†ç™¼æ ¸å¿ƒï¼‰
        # =========================
        # æœˆç‡Ÿæ”¶ YoY + MoMï¼šåŠ é€Ÿ & ç´šåˆ¥
        rev_yoy_score = rank(winsorize(ts_mean(zscore(monthly_rev_yoy, industry), 3), 0.01, 0.99), industry)
        rev_mom_score = rank(winsorize(ts_mean(zscore(monthly_rev_mom, industry), 3), 0.01, 0.99), industry)

        # è‡ªçµç²åˆ© YoYï¼ˆå– sa_ni_yoy ç‚ºä¸»ï¼Œsa_opi_yoy ç‚ºè¼”ï¼‰
        ni_yoy_score  = rank(winsorize(ts_mean(zscore(sa_ni_yoy, industry), 3), 0.01, 0.99), industry)
        opi_yoy_score = rank(winsorize(ts_mean(zscore(sa_opi_yoy, industry), 3), 0.01, 0.99), industry)
        profit_accel_score = 0.65 * ni_yoy_score + 0.35 * opi_yoy_score

        # åˆ©æ½¤ç‡æ”¹å–„ï¼ˆæŠ“ã€Œè®Šå¥½ã€ä¸æ˜¯æŠ“ã€Œå¾ˆé«˜ã€ï¼‰
        opm_imp = ts_delta(tej_opm, 4)
        gpm_imp = ts_delta(tej_gpm, 4)
        margin_imp_score = 0.6 * rank(winsorize(zscore(opm_imp, industry), 0.01, 0.99), industry) + \
                        0.4 * rank(winsorize(zscore(gpm_imp, industry), 0.01, 0.99), industry)

        fundamentals_score = (
            0.28 * rev_yoy_score +
            0.22 * rev_mom_score +
            0.4 * profit_accel_score +
            0.1 * margin_imp_score
        )

        # =========================
        # 6) ç±Œç¢¼ç¢ºèªï¼ˆå¤–è³‡/æŠ•ä¿¡æ¨å‡ï¼‰
        # =========================
        inst_net20 = ts_sum(qfii_net + fund_net, 20)
        inst_score = rank(winsorize(inst_net20, 0.01, 0.99), industry)

        hold_up = ts_delta(qfii_pct + fund_pct, 20)
        hold_score = rank(winsorize(hold_up, 0.01, 0.99), industry)

        chip_score = 0.65 * inst_score + 0.35 * hold_score

        # =========================
        # 7) é¢¨æ§ï¼šæ³¢å‹•æ‡²ç½° + éç†±æŠ‘åˆ¶
        # =========================
        volat20 = volatility(close, 20)
        vol_penalty = rank(winsorize(volat20, 0.01, 0.99), industry)

        rsi14 = rsi(close, 14)
        overheat = (rsi14 > 80).astype(float)
        overheat_penalty = 0.20 * overheat

        # =========================
        # 8) çµ„åˆï¼ˆGrowth Breakoutï¼‰
        # =========================
        raw_score = (
            0.08 * mom_score +
            0.12 * breakout_score +
            0.16 * vol_score +
            0.08 * turnover_score +
            0.32 * fundamentals_score +
            0.16 * chip_score +
            - 0.16 * vol_penalty
            - overheat_penalty
        )

        score = if_else(trend_ok, 1.25*raw_score, raw_score * 0.35)
        score = winsorize(score, 0.01, 0.99)
        score = ts_mean(zscore(score, industry), 3)

        return score
            
    # =========================================================================
    # é¸æ“‡æ€§æ–¹æ³•: filter_universe() - ç¯©é¸æŠ•è³‡ç¯„åœ
    # =========================================================================
    
    def filter_universe(self, db):
        """
        ç¯©é¸æŠ•è³‡ç¯„åœ (é¸æ“‡æ€§è¦†å¯«)
        
        è¿”å›å¸ƒæ— DataFrameï¼ŒTrue è¡¨ç¤ºè©²è‚¡ç¥¨å¯æŠ•è³‡
        
        å¸¸è¦‹ç¯©é¸æ¢ä»¶:
        - æ’é™¤æˆäº¤é‡éä½çš„è‚¡ç¥¨
        - æ’é™¤è‚¡åƒ¹éä½çš„è‚¡ç¥¨
        - æ’é™¤å¸‚å€¼éå°çš„è‚¡ç¥¨
        """
        close = db.get('close')
        volume = db.get('volume')
        mktcap = db.get('mktcap')
        
        # æ—¥æˆäº¤é‡‘é¡ > 500 è¬
        daily_amount = close * volume
        min_amount_filter = ts_mean(daily_amount, 20) > 5_000_000
        
        # è‚¡åƒ¹ > 10 å…ƒ
        price_filter = close.iloc[-1] > 10
        
        # å¸‚å€¼ > 50 å„„
        mktcap_filter = mktcap.iloc[-1].fillna(0) > 5_000_000_000
        
        return min_amount_filter & price_filter & mktcap_filter


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# åŸ·è¡Œå€å¡Š - ç›´æ¥åŸ·è¡Œæ­¤æª”æ¡ˆæœƒé€²è¡Œå›æ¸¬å’Œé…ç½®
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if __name__ == '__main__':
    from Platform import Backtester, get_allocation
    
    print("=" * 70)
    print(f"ğŸ“Š åŸ·è¡Œç­–ç•¥: {MyStrategy.name}")
    print("=" * 70)
    
    # å»ºç«‹ç­–ç•¥å¯¦ä¾‹
    strategy = MyStrategy()
    
    # =========================================================================
    # 1. åŸ·è¡Œå›æ¸¬
    # =========================================================================
    print("\nğŸ”„ åŸ·è¡Œå›æ¸¬...")
    
    result = Backtester.run(
        strategy=strategy,
        start_date="2022-02-07",      # é–‹å§‹æ—¥æœŸ (4å¹´å›æ¸¬)
        end_date=None,                 # çµæŸæ—¥æœŸ (None = æœ€æ–°)
        initial_capital=1_000_000,     # åˆå§‹è³‡é‡‘
        rebalance_freq="weekly",       # èª¿å€‰é »ç‡: daily, weekly, monthly
    )
    
    # é¡¯ç¤ºå›æ¸¬çµæœ
    print(result.summary())
    
    # ç¹ªè£½ç¸¾æ•ˆåœ–
    result.plot(save_path="performance.png")
    print("ğŸ“Š ç¸¾æ•ˆåœ–å·²å„²å­˜è‡³ performance.png")
    
    # =========================================================================
    # 2. å–å¾—ç•¶å‰é…ç½®å»ºè­°
    # =========================================================================
    print("\nğŸ“ˆ ç•¶å‰é…ç½®å»ºè­°:")
    
    allocation = get_allocation(
        strategy=strategy,
        capital=1_000_000,             # å¯ç”¨è³‡é‡‘
        max_positions=10,              # æœ€å¤§æŒå€‰æ•¸
    )
    
    print(allocation)
    
    # =========================================================================
    # 3. è¼¸å‡ºé…ç½®åˆ° CSV (å¯é¸)
    # =========================================================================
    # allocation.to_csv("my_allocation.csv")
    # print("âœ… å·²è¼¸å‡º my_allocation.csv")
