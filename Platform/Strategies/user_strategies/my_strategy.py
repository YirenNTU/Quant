#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
================================================================================
ğŸ“Š ç­–ç•¥ç¯„æœ¬ - Strategy Template
================================================================================

é€™æ˜¯ä¸€å€‹é€šç”¨çš„ç­–ç•¥ç¯„æœ¬ï¼Œä½ å¯ä»¥è¤‡è£½é€™å€‹æª”æ¡ˆä¸¦ä¿®æ”¹ compute() æ–¹æ³•ä¾†å»ºç«‹è‡ªå·±çš„ç­–ç•¥ã€‚

ä½¿ç”¨æ–¹å¼:
1. è¤‡è£½é€™å€‹æª”æ¡ˆä¸¦é‡æ–°å‘½åï¼Œä¾‹å¦‚: my_strategy.py
2. ä¿®æ”¹ name, description, params
3. åœ¨ compute() ä¸­å¯¦ä½œä½ çš„ç­–ç•¥é‚è¼¯
4. åŸ·è¡Œ: python my_strategy.py

================================================================================
"""

import sys
from pathlib import Path

# è¨­å®šè·¯å¾‘ (ç¢ºä¿å¯ä»¥ import Platform)
PROJECT_ROOT = Path(__file__).parent.parent.parent.parent
sys.path.insert(0, str(PROJECT_ROOT))

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# åŒ¯å…¥å¿…è¦æ¨¡çµ„
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

from Platform.Strategies import Strategy
from Platform.Factors import *

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ä½ çš„ç­–ç•¥
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

class MyStrategy(Strategy):
    """
    ç­–ç•¥æè¿°
    
    åœ¨é€™è£¡èªªæ˜ä½ çš„ç­–ç•¥é‚è¼¯...
    """
    
    # =========================================================================
    # åŸºæœ¬è³‡è¨Š (è«‹ä¿®æ”¹)
    # =========================================================================
    
    name = "æˆ‘çš„ç­–ç•¥"                    # ç­–ç•¥åç¨±
    description = "é€™æ˜¯æˆ‘çš„ç­–ç•¥èªªæ˜"      # ç­–ç•¥æè¿°
    version = "1.0"                      # ç‰ˆæœ¬
    author = "ä½ çš„åå­—"                  # ä½œè€…
    
    # =========================================================================
    # ç­–ç•¥åƒæ•¸ (å¯åœ¨é€™è£¡èª¿æ•´)
    # =========================================================================
    
    params = {
            "value_weight": 0.4,       # åƒ¹å€¼æ¬Šé‡
            "growth_weight": 0.4,      # è½‰æŠ˜æ¬Šé‡
            "chip_weight": 0.2,        # ç±Œç¢¼æ¬Šé‡
            "ma_filter": 60,           # è¶¨å‹¢éæ¿¾
        }
    
    # =========================================================================
    # æ ¸å¿ƒæ–¹æ³•: compute() - è¨ˆç®—å› å­åˆ†æ•¸ (å¿…é ˆå¯¦ä½œ)
    # =========================================================================
    
    def compute(self, db):
        """
        è¨ˆç®—å› å­åˆ†æ•¸
        
        Args:
            db: FieldDB è³‡æ–™åº«å¯¦ä¾‹ï¼Œç”¨æ–¼å–å¾—è³‡æ–™
        
        Returns:
            pd.DataFrame: å› å­åˆ†æ•¸ (rows=æ—¥æœŸ, cols=è‚¡ç¥¨)
                          åˆ†æ•¸è¶Šé«˜ä»£è¡¨è¶Šçœ‹å¥½é€™æª”è‚¡ç¥¨
        
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        å¯ç”¨è³‡æ–™ (ç”¨ db.get('æ¬„ä½åç¨±') å–å¾—)
        ğŸ“Œ æ‰€æœ‰è³‡æ–™éƒ½æœƒè‡ªå‹•å°é½Šåˆ°æ—¥å ±æ—¥æœŸï¼Œå¯ç›´æ¥é‹ç®—ï¼
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        ã€PRICE åƒ¹æ ¼é¡ã€‘21 å€‹æ¬„ä½ï¼Œå®Œæ•´åº¦ 99%+
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        close, open, high, low        æ”¶é–‹é«˜ä½åƒ¹
        volume, amount, trades        æˆäº¤é‡(è‚¡)ã€æˆäº¤é‡‘é¡ã€æˆäº¤ç­†æ•¸
        turnover                      é€±è½‰ç‡%
        mktcap, shares                å¸‚å€¼ã€æµé€šè‚¡æ•¸
        pe, pb, psr                   æœ¬ç›Šæ¯”ã€æ·¨å€¼æ¯”ã€ç‡Ÿæ”¶æ¯”
        pe_tej, pb_tej                PE/PB (TEJç‰ˆæœ¬)
        div_yield, cdiv_yield         æ®–åˆ©ç‡%ã€ç¾é‡‘æ®–åˆ©ç‡%
        daily_return, amplitude       æ—¥å ±é…¬ç‡%ã€æŒ¯å¹…%
        avgprc, adjfac                å‡åƒ¹ã€é‚„åŸå› å­
        
        ã€FINANCIALS è²¡å ±é¡ã€‘9 å€‹æ¬„ä½ï¼Œå®Œæ•´åº¦ 80%+ (å­£å ±é »ç‡)
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        revenue                       ç‡Ÿæ¥­æ”¶å…¥
        gross_profit                  æ¯›åˆ©
        net_income                    ç¨…å¾Œæ·¨åˆ©
        tej_gpm, tej_opm              æ¯›åˆ©ç‡%ã€ç‡Ÿç›Šç‡%
        inventory_turnover            å­˜è²¨é€±è½‰ç‡
        inventory_days                å­˜è²¨å¤©æ•¸
        dso                           æ‡‰æ”¶å¸³æ¬¾å¤©æ•¸
        days_payable                  æ‡‰ä»˜å¸³æ¬¾å¤©æ•¸
        
        ã€BALANCE_SHEET è³‡ç”¢è² å‚µé¡ã€‘5 å€‹æ¬„ä½ï¼Œå®Œæ•´åº¦ 80%+ (å­£å ±é »ç‡)
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        total_assets                  è³‡ç”¢ç¸½é¡
        total_debt                    è² å‚µç¸½é¡
        total_liabilities             ç¸½è² å‚µ
        current_assets                æµå‹•è³‡ç”¢
        accounts_receivable           æ‡‰æ”¶å¸³æ¬¾
        
        ã€CASHFLOW ç¾é‡‘æµé¡ã€‘1 å€‹æ¬„ä½ï¼Œå®Œæ•´åº¦ 94% (å­£å ±é »ç‡)
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        ocf                           ç‡Ÿæ¥­ç¾é‡‘æµ
        
        ã€CHIP ç±Œç¢¼é¡ã€‘9 å€‹æ¬„ä½ï¼Œå®Œæ•´åº¦ 100% (æ—¥é »)
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        qfii_net, fund_net            å¤–è³‡/æŠ•ä¿¡è²·è³£è¶…(å¼µ)
        dealer_net                    ä¸‰å¤§æ³•äººåˆè¨ˆ(å¼µ)
        qfii_pct, fund_pct            å¤–è³‡/æŠ•ä¿¡æŒè‚¡%
        dealer_pct                    è‡ªç‡Ÿå•†æŒè‚¡%
        margin_long, margin_short     èè³‡/èåˆ¸é¤˜é¡(å¼µ)
        short_ratio                   åˆ¸è³‡æ¯”%
        
        ã€CHIP_EXTENDED ç±Œç¢¼æ“´å……é¡ã€‘8 å€‹æ¬„ä½ï¼Œå®Œæ•´åº¦ 100% (æ—¥é »)
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        qfii_buy, qfii_sell           å¤–è³‡è²·é€²/è³£å‡ºé‡(å¼µ)
        fund_buy, fund_sell           æŠ•ä¿¡è²·é€²/è³£å‡ºé‡(å¼µ)
        margin_maintenance            èè³‡ç¶­æŒç‡%
        short_maintenance              èåˆ¸ç¶­æŒç‡%
        total_maintenance              æ•´æˆ¶ç¶­æŒç‡%
        stock_lending                 å€Ÿåˆ¸é¤˜é¡(å¼µ)
        
        ã€MONTHLY_SALES æœˆç‡Ÿæ”¶é¡ã€‘7 å€‹æ¬„ä½ï¼Œå®Œæ•´åº¦ 94% (æœˆé »)
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        monthly_rev                   ç•¶æœˆç‡Ÿæ”¶(åƒå…ƒ)
        monthly_rev_alt               æœˆç‡Ÿæ”¶(åƒå…ƒ)
        monthly_rev_yoy               æœˆç‡Ÿæ”¶YoY%
        monthly_rev_mom               æœˆç‡Ÿæ”¶MoM%
        ytd_rev                       ç´¯è¨ˆç‡Ÿæ”¶(åƒå…ƒ)
        ytd_rev_yoy                   ç´¯è¨ˆç‡Ÿæ”¶YoY%
        ytd_rev_yoy_pct               ç´¯è¨ˆç‡Ÿæ”¶MoM%
        
        ã€DIVIDEND è‚¡åˆ©é¡ã€‘18 å€‹æ¬„ä½ï¼Œå®Œæ•´åº¦ 98% (äº‹ä»¶é »ç‡)
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        cash_div, stock_div           ç¾é‡‘è‚¡åˆ©ã€è‚¡ç¥¨è‚¡åˆ©
        ern_div, cpl_div              ç›ˆé¤˜é…è‚¡ã€å…¬ç©é…è‚¡
        div_type                      é…æ¯é¡å‹
        div_beg_date, div_end_date    é…æ¯æœŸé–“èµ·/è¿„æ—¥
        div_year                      ç›ˆé¤˜åˆ†æ´¾å¹´åº¦
        div_payment_times             è‚¡åˆ©æ”¯ä»˜æ¬¡æ•¸
        div_payout_ratio              è‚¡åˆ©æ”¯ä»˜ç‡%
        ex_div_date, ex_right_date    é™¤æ¯æ—¥ã€é™¤æ¬Šæ—¥
        pay_date, stock_div_date      ç¾é‡‘/è‚¡ç¥¨è‚¡åˆ©ç™¼æ”¾æ—¥
        short_cover_date              é™¤æ¬Šæ¯æœ€å¾Œå›è£œæ—¥
        board_date                    è‘£äº‹æœƒæ—¥æœŸ
        shareholder_meeting_date      è‚¡æ±æœƒæ—¥æœŸ
        div_currency                  ç™¼æ”¾å¹£åˆ¥
        
        ã€CAPITAL è³‡æœ¬é¡ã€‘8 å€‹æ¬„ä½ï¼Œå®Œæ•´åº¦ 67% (äº‹ä»¶é »ç‡)
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        capital_amt                   è‚¡æœ¬(åƒå…ƒ)
        shares_outstanding             æµé€šè‚¡æ•¸(åƒè‚¡)
        cash_increase                 ç¾é‡‘å¢è³‡
        earning_increase               ç›ˆé¤˜è½‰å¢è³‡
        capital_reserve                è³‡æœ¬å…¬ç©
        employee_bonus                å“¡å·¥ç´…åˆ©
        capital_decrease               æ¸›è³‡
        capital_change_date            è³‡æœ¬è®Šæ›´æ—¥æœŸ
        
        ã€SELF_ANNOUNCED è‡ªçµè²¡å ±é¡ã€‘18 å€‹æ¬„ä½ï¼Œå®Œæ•´åº¦ 99% (å­£å ±é »ç‡)
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        sa_revenue                    è‡ªçµç‡Ÿæ”¶
        sa_gross_profit               è‡ªçµç‡Ÿæ¥­æ¯›åˆ©
        sa_opi                        è‡ªçµç‡Ÿæ¥­åˆ©ç›Š
        sa_pretax                     è‡ªçµç¨…å‰æ·¨åˆ©
        sa_net_income                 è‡ªçµç¨…å¾Œæ·¨åˆ©(åˆä½µç¸½æç›Š)
        sa_net_income_parent          è‡ªçµç¨…å¾Œæ·¨åˆ©(æ¯å…¬å¸)
        sa_eps                        è‡ªçµEPS
        sa_eps_pretax                 è‡ªçµæ¯è‚¡ç¨…å‰æ·¨åˆ©
        sa_eps_net                    è‡ªçµæ¯è‚¡ç¨…å¾Œæ·¨åˆ©
        sa_gpm                        è‡ªçµæ¯›åˆ©ç‡%
        sa_opm                        è‡ªçµç‡Ÿç›Šç‡%
        sa_pretax_npm                 è‡ªçµç¨…å‰æ·¨åˆ©ç‡%
        sa_npm                        è‡ªçµç¨…å¾Œæ·¨åˆ©ç‡%
        sa_rev_yoy                    è‡ªçµç‡Ÿæ”¶æˆé•·ç‡%
        sa_gm_yoy                     è‡ªçµç‡Ÿæ¥­æ¯›åˆ©æˆé•·ç‡%
        sa_opi_yoy                    è‡ªçµç‡Ÿæ¥­åˆ©ç›Šæˆé•·ç‡%
        sa_pretax_yoy                 è‡ªçµç¨…å‰æ·¨åˆ©æˆé•·ç‡%
        sa_ni_yoy                     è‡ªçµç¨…å¾Œæ·¨åˆ©æˆé•·ç‡%
        
        ã€SHAREHOLDING é›†ä¿åº«å­˜é¡ã€‘22 å€‹æ¬„ä½ï¼Œå®Œæ•´åº¦ 100% (æ—¥é »)
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        fc_shares                     é›†ä¿åº«å­˜è‚¡æ•¸(åƒè‚¡)
        pledged_shares                è¨­è³ªè‚¡æ•¸(åƒè‚¡)
        shrm_u400, shrs_u400, shrp_u400  æœªæ»¿400å¼µ: äººæ•¸/å¼µæ•¸/å æ¯”
        shrm_o400, shrs_o400, shrp_o400  è¶…é400å¼µ: äººæ•¸/å¼µæ•¸/å æ¯”
        shrm_4_6, shrs_4_6, shrp_4_6     400-600å¼µ: äººæ•¸/å¼µæ•¸/å æ¯”
        shrm_6_8, shrs_6_8, shrp_6_8     600-800å¼µ: äººæ•¸/å¼µæ•¸/å æ¯”
        shrm_8_10, shrs_8_10, shrp_8_10  800-1000å¼µ: äººæ•¸/å¼µæ•¸/å æ¯”
        shrm_o1000, shrs_o1000, shrp_o1000 è¶…é1000å¼µ: äººæ•¸/å¼µæ•¸/å æ¯”
        
        âš ï¸ TEJ åˆå…¥æ±Ÿæ¹–ç‰ˆç„¡è³‡æ–™ (è«‹å‹¿ä½¿ç”¨):
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        capex, icf, fcf               è³‡æœ¬æ”¯å‡ºã€æŠ•è³‡/ç±Œè³‡ç¾é‡‘æµ
        cash, inventory               ç¾é‡‘ã€å­˜è²¨
        
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        å¯ç”¨é‹ç®—å·¥å…·
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        ã€æ™‚åºé‹ç®— (Time-Series Operators)ã€‘
        ts_delay(data, periods)       N æœŸå‰çš„å€¼
        ts_delta(data, periods)       èˆ‡ N æœŸå‰çš„å·®å€¼
        ts_pct_change(data, periods)  N æœŸå ±é…¬ç‡
        ts_mean(data, window)         N æ—¥ç§»å‹•å¹³å‡
        ts_sum(data, window)          N æ—¥åŠ ç¸½
        ts_std(data, window)          N æ—¥æ¨™æº–å·®
        ts_max(data, window)          N æ—¥æœ€é«˜
        ts_min(data, window)          N æ—¥æœ€ä½
        ts_rank(data, window)        æ™‚åºæ’å (0~1)
        ts_zscore(data, window)      æ™‚åº Z-Score
        ts_corr(x, y, window)         æ»¾å‹•ç›¸é—œä¿‚æ•¸
        ts_cov(x, y, window)          æ»¾å‹•å…±è®Šç•°æ•¸
        ts_skew(data, window)         æ»¾å‹•åæ…‹
        ts_kurt(data, window)         æ»¾å‹•å³°æ…‹
        ts_argmax(data, window)       æœ€å¤§å€¼å¹¾æœŸå‰
        ts_argmin(data, window)       æœ€å°å€¼å¹¾æœŸå‰
        
        ã€æˆªé¢é‹ç®— (Cross-Section Operators)ã€‘
        rank(data, group=None)        æˆªé¢æ’å (0~1)ï¼Œå¯é¸åˆ†çµ„(ç”¢æ¥­å…§æ’å)
        zscore(data, group=None)      æˆªé¢ Z-Scoreï¼Œå¯é¸åˆ†çµ„(ç”¢æ¥­ä¸­æ€§åŒ–)
        demean(data)                  å»å‡å€¼
        neutralize(data, factor)      å°å› å­ä¸­æ€§åŒ–
        winsorize(data, lo, hi)       ç¸®å°¾è™•ç† (é è¨­ 0.01, 0.99)
        
        ã€è¡°æ¸›é‹ç®— (Decay Operators)ã€‘
        decay_linear(data, window)    ç·šæ€§è¡°æ¸›åŠ æ¬Š
        decay_exp(data, window)      æŒ‡æ•¸è¡°æ¸› (EMA)
        decay_power(data, window, p) å†ªæ¬¡è¡°æ¸›åŠ æ¬Š
        
        ã€é‚è¼¯é‹ç®— (Logical Operators)ã€‘
        if_else(cond, if_t, if_f)     æ¢ä»¶åˆ¤æ–·
        sign(data)                    ç¬¦è™Ÿå‡½æ•¸ (-1/0/1)
        abs_val(data)                 çµ•å°å€¼
        log(data)                      è‡ªç„¶å°æ•¸
        power(data, exp)               å†ªæ¬¡é‹ç®—
        
        ã€åŸºç¤é‹ç®— (Basic Operators)ã€‘
        add(a, b), subtract(a, b)    åŠ æ¸›é‹ç®—
        multiply(a, b), divide(a, b) ä¹˜é™¤é‹ç®—
        safe_divide(a, b, fill=0)     å®‰å…¨é™¤æ³•(é¿å…é™¤é›¶)
        
        ã€çµ„åˆå› å­ (Composite Factors)ã€‘
        momentum(data, periods)       å‹•é‡å› å­
        volatility(data, window)      æ³¢å‹•ç‡
        rsi(data, window=14)          RSI æŒ‡æ¨™ (0~100)
        bollinger_position(data, w, s) å¸ƒæ—é€šé“ä½ç½®
        macd(data, fast, slow, sig)   MACD æŒ‡æ¨™ (è¿”å› tuple)
        
        ã€ç”¢æ¥­åˆ†é¡å·¥å…· (Sector Tools)ã€‘
        load_sector(ref_df, field)    è¼‰å…¥ç”¢æ¥­è³‡æ–™
                                      field='sector' æˆ– 'industry'
                                      ç¯„ä¾‹: industry = load_sector(close, 'industry')
                                      æ­é… rank/zscore ä½¿ç”¨: rank(pe, industry)
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        """
        
        # =====================================================================
        # åœ¨é€™è£¡å¯¦ä½œä½ çš„ç­–ç•¥é‚è¼¯
        # =====================================================================
        
        # =========================
        # 1) å–è³‡æ–™ï¼ˆå…¨éƒ¨éƒ½æ˜¯ DB ç¢ºå®šå­˜åœ¨çš„æ¬„ä½ï¼‰
        # =========================
        close = db.get("close")
        pb = db.get("pb")
        daily_return = db.get("daily_return")
        fund_net = db.get("fund_net")
        shares = db.get("shares")
        amount = db.get("amount")
        tej_opm = db.get("tej_opm")  # å¯ç”¨ä¾†åš value-trap é˜²å‘†ï¼ˆå¾ˆè¼•é‡ï¼‰

        industry = load_sector(close, "industry")
        sector = load_sector(close, "sector")

        # ===== åƒæ•¸ =====
        vw = self.params.get("value_weight", 0.4)
        gw = self.params.get("growth_weight", 0.4)   # momentum æ¬Šé‡
        cw = self.params.get("chip_weight", 0.2)
        ma_n = self.params.get("ma_filter", 60)

        # ===== å°å·¥å…·ï¼šç¸®å°¾ =====
        def w(x):
            return winsorize(x, 0.01, 0.99)

        # =========================================================
        # 1) Valueï¼šPB è¶Šä½è¶Šå¥½ï¼ˆç”¢æ¥­å…§ï¼‰
        #    åŠ ä¸€å€‹è¶…è¼•é‡ value-trap é˜²å‘†ï¼štej_opm<=0 æ™‚ value æ‰“æŠ˜
        # =========================================================
        value = 1 - rank(w(pb), industry)

        # è‹¥ tej_opm ç¼ºå€¼ï¼Œè¦–ç‚ºã€Œä¸é˜»æ“‹ã€ï¼ˆé¿å…è³‡æ–™ä¸å…¨å®³ä½ å°‘è²·å¾ˆå¤šï¼‰
        quality_gate = tej_opm.isna() | (tej_opm > 0)
        value = if_else(quality_gate, value, value * 0.5)

        # =========================================================
        # 2) Momentumï¼š120æ—¥å ±é…¬ è¶Šé«˜è¶Šå¥½ï¼ˆç”¢æ¥­å…§ï¼‰
        # =========================================================
        mom = rank(w(ts_pct_change(close, 120)), industry)

        # =========================================================
        # 3) Chipï¼šæŠ•ä¿¡è¿‘10æ—¥æ·¨è²·è¶…ï¼ˆå…ˆå°ºåº¦ä¿®æ­£ï¼Œå†åšç”¢æ¥­å…§ï¼‰
        #    fund_net(å¼µ) -> *1000 è‚¡ï¼Œå†é™¤ä»¥ shares(è‚¡)
        # =========================================================
        fund_flow = safe_divide(fund_net * 1000, shares, fill=0)
        chip = rank(w(ts_sum(fund_flow, 10)), industry)
        chip_2 = rank(ts_zscore(ts_mean(fund_flow, 10),120), industry)

        # =========================================================
        # 4) è¶¨å‹¢æ¿¾ç¶²ï¼šè·Œç ´ MA_n å°±é™æ›éšª
        # =========================================================
        trend_ok = close > ts_mean(close, ma_n)

        # =========================================================
        # 5) æ³¢å‹•æŠ˜æ‰£ï¼šé«˜æ³¢å‹•æ‰£åˆ†ï¼ˆç”¢æ¥­å…§åå‘ï¼‰
        # =========================================================
        vol = w(ts_std(daily_return, 60))
        vol_score = 1 - rank(vol, sector)         # è¶Šç©©è¶Šé«˜
        risk_mult = 0.6 + 0.4 * vol_score           # 0.6 ~ 1.0ï¼ˆæ¯”ä¸Šä¸€ç‰ˆç¨å¾®æ›´ä¿å®ˆï¼‰

        # =========================================================
        # 6) è¼•é‡æµå‹•æ€§æŠ˜æ‰£ï¼šé¿å…å¯¦ç›¤æ»‘åƒ¹
        # =========================================================
        liq = rank(w(ts_mean(amount, 20)), industry)
        liq_mult = 0.8 + 0.2 * liq                  # 0.8 ~ 1.0

        # =========================================================
        # 7) å¸‚å ´é¢¨éšªæ¿¾ç¶²ï¼ˆé—œéµï¼‰ï¼šå¸‚å ´ < MA200 â†’ å…¨é«”æ‰“æŠ˜
        #    ç”¨å…¨å¸‚å ´å¹³å‡ close ç•¶ proxyï¼ˆä¸éœ€è¦é¡å¤–è³‡æ–™ï¼‰
        # =========================================================
        market = close.mean(axis=1)                 # Series: æ¯æ—¥å¸‚å ´ä»£ç†
        market_ok = market > market.rolling(200).mean()
        market_ok_df = (close * 0).add(market_ok.astype(float), axis=0)  # broadcast åˆ°æ‰€æœ‰è‚¡ç¥¨
        market_mult = 0.5 + 0.5 * market_ok_df      # å¥½=1.0ï¼Œå£=0.5

        # =========================================================
        # 8) åˆæˆ core
        # =========================================================
        core = vw * value + gw * mom + cw * chip

        total = core * risk_mult * liq_mult * market_mult

        # =========================================================
        # 9) æ€¥è·Œä¿è­·ï¼š20æ—¥è·Œå¹… < -15% â†’ ç›´æ¥ 0ï¼ˆç å°–åˆº DDï¼‰
        # =========================================================
        crash = ts_pct_change(close, 20) < -0.30
        total = if_else(crash, 0.5 * total, total)

        # =========================================================
        # 10) é™æ›æ‰‹ï¼šå°åˆ†æ•¸åš EMA å¹³æ»‘ï¼ˆä¸åŠ åƒæ•¸ï¼Œç”¨ 5 å¤©ï¼‰
        # =========================================================
        total = decay_exp(total, 20)
        # =========================================================
        # A) å…ˆæŠŠä½ åŸæœ¬çš„ç­–ç•¥çµæœå‘½åæˆ bull_total
        #    ï¼ˆä¹Ÿå°±æ˜¯ä½ ç›®å‰ç®—å¥½çš„ totalï¼‰
        # =========================================================
        bull_total = total

        # =========================================================
        # B) ç›¤æ•´åµæ¸¬ï¼šranging_prob (0~1)
        # =========================================================
        high = db.get("high")
        low = db.get("low")

        market = close.mean(axis=1)
        ma200_m = market.rolling(200).mean()
        ma200_slope = ma200_m.pct_change(20)

        # MA200æ–œç‡è¶Šæ¥è¿‘0è¶Šç›¤æ•´
        slope_flat = (abs_val(ma200_slope) < 0.001).astype(float)  # å¯èª¿ï¼šè¶Šå°è¶Šåš´

        # è¶¨å‹¢å¼·åº¦ proxyï¼šæ·¨ç§»å‹• / ATRå æ¯”ï¼ˆè¶Šå¤§è¶Šè¶¨å‹¢ï¼‰
        atr_20 = (high - low).rolling(20).mean()
        atr_ratio = safe_divide(atr_20, close, fill=0)
        net_move = abs_val(ts_pct_change(close, 20))
        trend_strength = safe_divide(net_move, atr_ratio + 0.001, fill=0)

        # è¶¨å‹¢å¼·åº¦è¶Šä½è¶Šç›¤æ•´ï¼ˆç”¨æ¯æ—¥æˆªé¢åˆ†ä½æ•¸åšé–€æª»ï¼‰
        ts_th = trend_strength.quantile(0.30, axis=1).values[:, None]
        is_ranging = (trend_strength < ts_th).astype(float)

        # æ³¢å‹•æ”¶æ–‚ï¼šATR ratio < è‡ªå·±60æ—¥å‡å€¼
        atr_ratio_60 = ts_mean(atr_ratio, 60)
        vol_compress = (atr_ratio < atr_ratio_60).astype(float)

        # åˆæˆç›¤æ•´æ©Ÿç‡ï¼ˆ0~1ï¼‰
        ranging_prob = 0.40 * slope_flat + 0.40 * is_ranging.mean(axis=1) + 0.20 * vol_compress.mean(axis=1)
        ranging_prob = ranging_prob.clip(0, 1)

        # broadcast åˆ°è‚¡ç¥¨ç¶­åº¦
        ranging_prob_df = (close * 0).add(ranging_prob, axis=0)

        # =========================================================
        # C) ç›¤æ•´ç­–ç•¥ï¼šçŸ­æœŸåè½‰ï¼ˆcross-sectional mean reversionï¼‰
        #    ç›®æ¨™ï¼šä½æ›æ‰‹ã€åƒç›¤æ•´çš„å°åè½‰
        # =========================================================
        industry = load_sector(close, "industry")

        # 5~10æ—¥è·Œæ·±ï¼ˆè¶Šè·Œè¶Šè²·ï¼‰
        rev_5 = 1 - rank(w(ts_pct_change(close, 5)), industry)
        rev_10 = 1 - rank(w(ts_pct_change(close, 10)), industry)
        reversal = 0.3 * rev_5 + 0.7 * rev_10

        # å¸ƒæ—ä¸‹ç·£ï¼ˆè¶Šé è¿‘ä¸‹ç·£è¶Šè²·ï¼‰
        boll_pos = bollinger_position(close, 20, 2.0)
        boll_score = 1 - rank(w(boll_pos), industry)
        below_lower = (boll_pos < 0).astype(float) * 0.2
        boll_score = rank(w(boll_score + below_lower), industry)

        # ç±Œç¢¼ï¼šæŠ•ä¿¡è²·è¶…ç¢ºèªï¼ˆä½ åŸæœ¬å·²ç®— fund_flow/chip ä¹Ÿå¯ç›´æ¥æ²¿ç”¨ï¼‰
        fund_flow = safe_divide(fund_net * 1000, shares, fill=0)
        chip_range = rank(w(ts_sum(fund_flow, 10)), industry)

        # çµ„åˆç›¤æ•´åˆ†æ•¸
        range_total = 0.50 * reversal + 0.30 * boll_score + 0.20 * chip_range

        # ç›¤æ•´ç­–ç•¥ä¹Ÿè¦é¿é–‹ã€Œå´©ç›¤è¶¨å‹¢ã€
        crash_fast = ts_pct_change(close, 5) < -0.15
        crash_slow = ts_pct_change(close, 20) < -0.30
        range_total = if_else(crash_fast | crash_slow, 0, range_total)

        # é™æ›æ‰‹ï¼ˆç›¤æ•´ç­–ç•¥ä¸€å®šè¦ç©©ï¼‰
        range_total = ts_mean(range_total, 10)
        range_total = decay_exp(range_total, 20)

        # =========================================================
        # D) Regime Switchingï¼šæ··åˆå…©ç­–ç•¥
        # =========================================================
        total = (1 - ranging_prob_df) * bull_total + ranging_prob_df * range_total

        # æœ€å¾Œå†å¹³æ»‘ä¸€æ¬¡ï¼Œé¿å… regime é‚Šç•ŒæŠ–å‹•é€ æˆæ›æ‰‹
        total = ts_mean(total, 10)
        total = decay_exp(total, 30)

        # =========================================================
        # 11) æœ€çµ‚æ¨™æº–åŒ–ï¼šç¢ºä¿åˆ†æ•¸åœ¨åˆç†ç¯„åœå…§ï¼ˆé¿å…ç•°å¸¸å·¨å¤§çš„å€¼ï¼‰
        #     ä½¿ç”¨æˆªé¢ Z-score æ¨™æº–åŒ–ï¼Œç„¶å¾Œç¸®æ”¾åˆ° 0-1 ç¯„åœ
        # =========================================================
        # å°æ¯ä¸€è¡Œï¼ˆæ—¥æœŸï¼‰é€²è¡Œæˆªé¢æ¨™æº–åŒ–
        total_mean = total.mean(axis=1)
        total_std = total.std(axis=1)
        # é¿å…é™¤é›¶
        total_std = total_std.replace(0, 1)
        total_normalized = total.sub(total_mean, axis=0).div(total_std, axis=0)
        
        # ç¸®æ”¾åˆ° 0-1 ç¯„åœï¼ˆä½¿ç”¨ min-maxï¼‰
        total_min = total_normalized.min(axis=1)
        total_max = total_normalized.max(axis=1)
        total_range = total_max - total_min
        total_range = total_range.replace(0, 1)  # é¿å…é™¤é›¶
        total = total_normalized.sub(total_min, axis=0).div(total_range, axis=0)

        return total.fillna(0)
            
    # =========================================================================
    # é¸æ“‡æ€§æ–¹æ³•: filter_universe() - ç¯©é¸æŠ•è³‡ç¯„åœ
    # =========================================================================
    
    def filter_universe(self, db):
        """
        ç¯©é¸æŠ•è³‡ç¯„åœ (é¸æ“‡æ€§è¦†å¯«)
        
        è¿”å›å¸ƒæ— DataFrameï¼ŒTrue è¡¨ç¤ºè©²è‚¡ç¥¨å¯æŠ•è³‡
        
        å¸¸è¦‹ç¯©é¸æ¢ä»¶:
        - æ’é™¤æˆäº¤é‡éä½çš„è‚¡ç¥¨
        - æ’é™¤è‚¡åƒ¹éä½çš„è‚¡ç¥¨
        - æ’é™¤å¸‚å€¼éå°çš„è‚¡ç¥¨
        """
        close = db.get('close')
        volume = db.get('volume')
        mktcap = db.get('mktcap')
        
        # æ—¥æˆäº¤é‡‘é¡ > 500 è¬
        daily_amount = close * volume
        min_amount_filter = ts_mean(daily_amount, 20) > 5_000_000
        
        # è‚¡åƒ¹ > 10 å…ƒ
        price_filter = close.iloc[-1] > 10
        
        # å¸‚å€¼ > 50 å„„
        mktcap_filter = mktcap.iloc[-1].fillna(0) > 5_000_000_000
        
        return min_amount_filter & price_filter & mktcap_filter


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# åŸ·è¡Œå€å¡Š - ç›´æ¥åŸ·è¡Œæ­¤æª”æ¡ˆæœƒé€²è¡Œå›æ¸¬å’Œé…ç½®
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if __name__ == '__main__':
    from Platform import Backtester, get_allocation
    
    print("=" * 70)
    print(f"ğŸ“Š åŸ·è¡Œç­–ç•¥: {MyStrategy.name}")
    print("=" * 70)
    
    # å»ºç«‹ç­–ç•¥å¯¦ä¾‹ (top_n=10: å›æ¸¬èˆ‡é…ç½®å‡æŒå€‰ 10 æª”)
    strategy = MyStrategy(top_n=10)
    
    # =========================================================================
    # 1. åŸ·è¡Œå›æ¸¬
    # =========================================================================
    print("\nğŸ”„ åŸ·è¡Œå›æ¸¬...")
    
    result = Backtester.run(
        strategy=strategy,
        start_date="2021-03-01",      # é–‹å§‹æ—¥æœŸ (é…åˆ TEJ è³‡æ–™ç¯„åœ)
        end_date=None,                 # çµæŸæ—¥æœŸ (None = æœ€æ–°)
        initial_capital=100_000,     # åˆå§‹è³‡é‡‘
        rebalance_freq="weekly",       # èª¿å€‰é »ç‡: daily, weekly, monthly
        allow_fractional=True,         # å•Ÿç”¨é›¶è‚¡äº¤æ˜“ï¼ˆèˆ‡ allocation ä¸€è‡´ï¼‰
    )
    
    # é¡¯ç¤ºå›æ¸¬çµæœ
    print(result.summary())
    
    # ç¹ªè£½ç¸¾æ•ˆåœ–
    result.plot(save_path="performance.png")
    print("ğŸ“Š ç¸¾æ•ˆåœ–å·²å„²å­˜è‡³ performance.png")
    
    # =========================================================================
    # 2. å–å¾—ç•¶å‰é…ç½®å»ºè­°
    # =========================================================================
    print("\nğŸ“ˆ ç•¶å‰é…ç½®å»ºè­°:")
    
    allocation = get_allocation(
        strategy=strategy,
        capital=100_000,             # å¯ç”¨è³‡é‡‘
        max_positions=10,              # æœ€å¤§æŒå€‰æ•¸ (èˆ‡ top_n ä¸€è‡´)
        allow_fractional=True,         # å•Ÿç”¨é›¶è‚¡äº¤æ˜“ï¼ˆé«˜åƒ¹è‚¡ 1 å¼µå¯èƒ½è¶…éåˆ†é…é‡‘é¡ï¼‰
    )
    
    print(allocation)
    
    # =========================================================================
    # 3. è¼¸å‡ºé…ç½®åˆ° CSV (å¯é¸)
    # =========================================================================
    # allocation.to_csv("my_allocation.csv")
    # print("âœ… å·²è¼¸å‡º my_allocation.csv")
