#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
================================================================================
ğŸ“Š ç­–ç•¥ç¯„æœ¬ - Strategy Template
================================================================================

é€™æ˜¯ä¸€å€‹é€šç”¨çš„ç­–ç•¥ç¯„æœ¬ï¼Œä½ å¯ä»¥è¤‡è£½é€™å€‹æª”æ¡ˆä¸¦ä¿®æ”¹ compute() æ–¹æ³•ä¾†å»ºç«‹è‡ªå·±çš„ç­–ç•¥ã€‚

ä½¿ç”¨æ–¹å¼:
1. è¤‡è£½é€™å€‹æª”æ¡ˆä¸¦é‡æ–°å‘½åï¼Œä¾‹å¦‚: my_strategy.py
2. ä¿®æ”¹ name, description, params
3. åœ¨ compute() ä¸­å¯¦ä½œä½ çš„ç­–ç•¥é‚è¼¯
4. åŸ·è¡Œ: python my_strategy.py

================================================================================
"""

import sys
from pathlib import Path

# è¨­å®šè·¯å¾‘ (ç¢ºä¿å¯ä»¥ import Platform)
PROJECT_ROOT = Path(__file__).parent.parent.parent.parent
sys.path.insert(0, str(PROJECT_ROOT))

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# åŒ¯å…¥å¿…è¦æ¨¡çµ„
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

from Platform.Strategies import Strategy
from Platform.Factors import *

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ä½ çš„ç­–ç•¥
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

class MyStrategy(Strategy):
    """
    ç­–ç•¥æè¿°
    
    åœ¨é€™è£¡èªªæ˜ä½ çš„ç­–ç•¥é‚è¼¯...
    """
    
    # =========================================================================
    # åŸºæœ¬è³‡è¨Š (è«‹ä¿®æ”¹)
    # =========================================================================
    
    name = "æˆ‘çš„ç­–ç•¥"                    # ç­–ç•¥åç¨±
    description = "é€™æ˜¯æˆ‘çš„ç­–ç•¥èªªæ˜"      # ç­–ç•¥æè¿°
    version = "1.0"                      # ç‰ˆæœ¬
    author = "ä½ çš„åå­—"                  # ä½œè€…
    
    # =========================================================================
    # ç­–ç•¥åƒæ•¸ (å¯åœ¨é€™è£¡èª¿æ•´)
    # =========================================================================
    
    params = {
        "lookback": 20,      # å‹•é‡å›çœ‹æœŸæ•¸
        "top_n": 10,         # æŒæœ‰è‚¡ç¥¨æ•¸é‡
        # å¯ä»¥æ–°å¢æ›´å¤šåƒæ•¸...
    }
    
    # =========================================================================
    # æ ¸å¿ƒæ–¹æ³•: compute() - è¨ˆç®—å› å­åˆ†æ•¸ (å¿…é ˆå¯¦ä½œ)
    # =========================================================================
    
    def compute(self, db):
        """
        è¨ˆç®—å› å­åˆ†æ•¸
        
        Args:
            db: FieldDB è³‡æ–™åº«å¯¦ä¾‹ï¼Œç”¨æ–¼å–å¾—è³‡æ–™
        
        Returns:
            pd.DataFrame: å› å­åˆ†æ•¸ (rows=æ—¥æœŸ, cols=è‚¡ç¥¨)
                          åˆ†æ•¸è¶Šé«˜ä»£è¡¨è¶Šçœ‹å¥½é€™æª”è‚¡ç¥¨
        
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        å¯ç”¨è³‡æ–™ (ç”¨ db.get('æ¬„ä½åç¨±') å–å¾—)
        ğŸ“Œ æ‰€æœ‰è³‡æ–™éƒ½æœƒè‡ªå‹•å°é½Šåˆ°æ—¥å ±æ—¥æœŸï¼Œå¯ç›´æ¥é‹ç®—ï¼
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        ã€PRICE åƒ¹æ ¼é¡ã€‘21 å€‹æ¬„ä½ï¼Œå®Œæ•´åº¦ 99%+
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        close, open, high, low        æ”¶é–‹é«˜ä½
        volume, amount, trades        æˆäº¤é‡ã€é‡‘é¡ã€ç­†æ•¸
        turnover                      é€±è½‰ç‡%
        mktcap, shares                å¸‚å€¼ã€æµé€šè‚¡æ•¸
        pe, pb, psr                   æœ¬ç›Šæ¯”ã€æ·¨å€¼æ¯”ã€ç‡Ÿæ”¶æ¯”
        pe_tej, pb_tej                PE/PB (TEJ)
        div_yield, cdiv_yield         æ®–åˆ©ç‡ã€ç¾é‡‘æ®–åˆ©ç‡
        daily_return, amplitude       æ—¥å ±é…¬ç‡ã€æŒ¯å¹…
        avgprc, adjfac                å‡åƒ¹ã€é‚„åŸå› å­
        
        ã€FINANCIALS è²¡å ±é¡ã€‘9 å€‹æ¬„ä½ï¼Œå®Œæ•´åº¦ 80%+
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        revenue                       ç‡Ÿæ¥­æ”¶å…¥
        gross_profit                  æ¯›åˆ©
        net_income                    ç¨…å¾Œæ·¨åˆ©
        tej_gpm, tej_opm              æ¯›åˆ©ç‡%ã€ç‡Ÿç›Šç‡%
        inventory_turnover            å­˜è²¨é€±è½‰ç‡
        inventory_days                å­˜è²¨å¤©æ•¸
        dso                           æ‡‰æ”¶å¸³æ¬¾å¤©æ•¸
        days_payable                  æ‡‰ä»˜å¸³æ¬¾å¤©æ•¸
        
        ã€BALANCE_SHEET è³‡ç”¢è² å‚µé¡ã€‘5 å€‹æ¬„ä½ï¼Œå®Œæ•´åº¦ 80%+
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        total_assets                  è³‡ç”¢ç¸½é¡
        total_debt                    è² å‚µç¸½é¡
        total_liabilities             ç¸½è² å‚µ
        current_assets                æµå‹•è³‡ç”¢
        accounts_receivable           æ‡‰æ”¶å¸³æ¬¾
        
        ã€CASHFLOW ç¾é‡‘æµé¡ã€‘1 å€‹æ¬„ä½ï¼Œå®Œæ•´åº¦ 94%
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        ocf                           ç‡Ÿæ¥­ç¾é‡‘æµ
        
        ã€CHIP ç±Œç¢¼é¡ã€‘9 å€‹æ¬„ä½ï¼Œå®Œæ•´åº¦ 100%
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        qfii_net, fund_net            å¤–è³‡/æŠ•ä¿¡è²·è³£è¶…(å¼µ)
        dealer_net                    ä¸‰å¤§æ³•äººåˆè¨ˆ
        qfii_pct, fund_pct            å¤–è³‡/æŠ•ä¿¡æŒè‚¡%
        dealer_pct                    è‡ªç‡Ÿå•†æŒè‚¡%
        margin_long, margin_short     èè³‡/èåˆ¸é¤˜é¡(å¼µ)
        short_ratio                   åˆ¸è³‡æ¯”%
        
        ã€MONTHLY_SALES æœˆç‡Ÿæ”¶é¡ã€‘6 å€‹æ¬„ä½ï¼Œå®Œæ•´åº¦ 94%
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        monthly_rev                   ç•¶æœˆç‡Ÿæ”¶(åƒå…ƒ)
        monthly_rev_alt               æœˆç‡Ÿæ”¶(åƒå…ƒ)
        monthly_rev_yoy               æœˆç‡Ÿæ”¶YoY%
        monthly_rev_mom               æœˆç‡Ÿæ”¶MoM%
        ytd_rev                       ç´¯è¨ˆç‡Ÿæ”¶(åƒå…ƒ)
        ytd_rev_yoy                   ç´¯è¨ˆç‡Ÿæ”¶YoY%
        
        âš ï¸ TEJ åˆå…¥æ±Ÿæ¹–ç‰ˆç„¡è³‡æ–™ (è«‹å‹¿ä½¿ç”¨):
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        capex, icf, fcf               è³‡æœ¬æ”¯å‡ºã€æŠ•è³‡/ç±Œè³‡ç¾é‡‘æµ
        cash, inventory               ç¾é‡‘ã€å­˜è²¨
        
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        å¯ç”¨é‹ç®—å·¥å…·
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        ã€æ™‚åºé‹ç®—ã€‘
        ts_delay(data, n)             N æœŸå‰çš„å€¼
        ts_delta(data, n)             èˆ‡ N æœŸå‰çš„å·®å€¼
        ts_pct_change(data, n)        N æœŸå ±é…¬ç‡
        ts_mean(data, n)              N æ—¥ç§»å‹•å¹³å‡
        ts_sum(data, n)               N æ—¥åŠ ç¸½
        ts_std(data, n)               N æ—¥æ¨™æº–å·®
        ts_max(data, n)               N æ—¥æœ€é«˜
        ts_min(data, n)               N æ—¥æœ€ä½
        ts_rank(data, n)              æ™‚åºæ’å (0~1)
        ts_zscore(data, n)            æ™‚åº Z-Score
        ts_corr(x, y, n)              æ»¾å‹•ç›¸é—œä¿‚æ•¸
        ts_argmax(data, n)            æœ€å¤§å€¼å¹¾æœŸå‰
        ts_argmin(data, n)            æœ€å°å€¼å¹¾æœŸå‰
        
        ã€æˆªé¢é‹ç®—ã€‘
        rank(data)                    æˆªé¢æ’å (0~1)
        zscore(data)                  æˆªé¢ Z-Score æ¨™æº–åŒ–
        demean(data)                  å»å‡å€¼
        winsorize(data, lo, hi)       ç¸®å°¾è™•ç†
        
        ã€è¡°æ¸›é‹ç®—ã€‘
        decay_linear(data, n)         ç·šæ€§è¡°æ¸›åŠ æ¬Š
        decay_exp(data, n)            æŒ‡æ•¸è¡°æ¸› (EMA)
        
        ã€çµ„åˆå› å­ã€‘
        momentum(data, n)             å‹•é‡
        volatility(data, n)           æ³¢å‹•ç‡
        rsi(data, n)                  RSI æŒ‡æ¨™
        bollinger_position(data, n)   å¸ƒæ—é€šé“ä½ç½®
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        """
        
        # =====================================================================
        # åœ¨é€™è£¡å¯¦ä½œä½ çš„ç­–ç•¥é‚è¼¯
        # =====================================================================
        
        # --- è¼‰å…¥è³‡æ–™ ---
        close = db.get('close')
        volume = db.get('volume')
        pe = db.get('pe')
        div_yield = db.get('div_yield')
        
        # --- è¨ˆç®—å› å­ ---
        
        # å› å­ 1: å‹•é‡ (éå» N å¤©å ±é…¬ç‡)
        momentum_factor = ts_pct_change(close, self.params["lookback"])
        
        # å› å­ 2: æˆäº¤é‡æ’å
        volume_factor = ts_rank(volume, 20)
        
        # å› å­ 3: åƒ¹å€¼ (PE è¶Šä½è¶Šå¥½)
        value_factor = -pe.ffill()
        
        # å› å­ 4: é«˜è‚¡æ¯
        dividend_factor = div_yield.ffill()
        
        # --- æ¨™æº–åŒ– ---
        mom_score = zscore(momentum_factor)
        vol_score = zscore(volume_factor)
        val_score = zscore(value_factor)
        div_score = zscore(dividend_factor)
        
        # --- çµ„åˆåˆ†æ•¸ ---
        # èª¿æ•´æ¬Šé‡ä¾†æ”¹è®Šç­–ç•¥ç‰¹æ€§
        score = (
            0.30 * mom_score +    # å‹•é‡æ¬Šé‡ 30%
            0.20 * vol_score +    # æˆäº¤é‡æ¬Šé‡ 20%
            0.25 * val_score +    # åƒ¹å€¼æ¬Šé‡ 25%
            0.25 * div_score      # è‚¡æ¯æ¬Šé‡ 25%
        )
        
        return score
    
    # =========================================================================
    # é¸æ“‡æ€§æ–¹æ³•: filter_universe() - ç¯©é¸æŠ•è³‡ç¯„åœ
    # =========================================================================
    
    def filter_universe(self, db):
        """
        ç¯©é¸æŠ•è³‡ç¯„åœ (é¸æ“‡æ€§è¦†å¯«)
        
        è¿”å›å¸ƒæ— DataFrameï¼ŒTrue è¡¨ç¤ºè©²è‚¡ç¥¨å¯æŠ•è³‡
        
        å¸¸è¦‹ç¯©é¸æ¢ä»¶:
        - æ’é™¤æˆäº¤é‡éä½çš„è‚¡ç¥¨
        - æ’é™¤è‚¡åƒ¹éä½çš„è‚¡ç¥¨
        - æ’é™¤å¸‚å€¼éå°çš„è‚¡ç¥¨
        """
        close = db.get('close')
        volume = db.get('volume')
        mktcap = db.get('mktcap')
        
        # æ—¥æˆäº¤é‡‘é¡ > 500 è¬
        daily_amount = close * volume
        min_amount_filter = ts_mean(daily_amount, 20) > 5_000_000
        
        # è‚¡åƒ¹ > 10 å…ƒ
        price_filter = close.iloc[-1] > 10
        
        # å¸‚å€¼ > 50 å„„
        mktcap_filter = mktcap.iloc[-1].fillna(0) > 5_000_000_000
        
        return min_amount_filter & price_filter & mktcap_filter


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# åŸ·è¡Œå€å¡Š - ç›´æ¥åŸ·è¡Œæ­¤æª”æ¡ˆæœƒé€²è¡Œå›æ¸¬å’Œé…ç½®
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if __name__ == '__main__':
    from Platform import Backtester, get_allocation
    
    print("=" * 70)
    print(f"ğŸ“Š åŸ·è¡Œç­–ç•¥: {MyStrategy.name}")
    print("=" * 70)
    
    # å»ºç«‹ç­–ç•¥å¯¦ä¾‹
    strategy = MyStrategy()
    
    # =========================================================================
    # 1. åŸ·è¡Œå›æ¸¬
    # =========================================================================
    print("\nğŸ”„ åŸ·è¡Œå›æ¸¬...")
    
    result = Backtester.run(
        strategy=strategy,
        start_date="2024-06-01",      # é–‹å§‹æ—¥æœŸ
        end_date=None,                 # çµæŸæ—¥æœŸ (None = æœ€æ–°)
        initial_capital=1_000_000,     # åˆå§‹è³‡é‡‘
        rebalance_freq="weekly",       # èª¿å€‰é »ç‡: daily, weekly, monthly
    )
    
    # é¡¯ç¤ºå›æ¸¬çµæœ
    print(result.summary())
    
    # ç¹ªè£½ç¸¾æ•ˆåœ–
    result.plot(save_path="performance.png")
    print("ğŸ“Š ç¸¾æ•ˆåœ–å·²å„²å­˜è‡³ performance.png")
    
    # =========================================================================
    # 2. å–å¾—ç•¶å‰é…ç½®å»ºè­°
    # =========================================================================
    print("\nğŸ“ˆ ç•¶å‰é…ç½®å»ºè­°:")
    
    allocation = get_allocation(
        strategy=strategy,
        capital=1_000_000,             # å¯ç”¨è³‡é‡‘
        max_positions=10,              # æœ€å¤§æŒå€‰æ•¸
    )
    
    print(allocation)
    
    # =========================================================================
    # 3. è¼¸å‡ºé…ç½®åˆ° CSV (å¯é¸)
    # =========================================================================
    # allocation.to_csv("my_allocation.csv")
    # print("âœ… å·²è¼¸å‡º my_allocation.csv")
